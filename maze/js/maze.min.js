/**
 * @file 走迷宫游戏的实现. (https://github.com/knightyun/maze-game)
 * @copyright 2020 knightyun. <https://raw.githubusercontent.com/knightyun/maze-game/master/maze.js>
 * @license MIT License. <https://raw.githubusercontent.com/knightyun/maze-game/master/LICENSE>
 */
class Maze{constructor(e){this.elMaze=e.elMaze,this.elBall=e.elBall,this.w=e.width||31,this.h=e.height||31,this.step=e.step||10,this.ballDia=e.ballDia||6,this.gameLevel=e.gameLevel||0,this.keyDownHandler=this.keyDownHandler.bind(this),this.keyUpHandler=this.keyUpHandler.bind(this),this.motionHandler=this.motionHandler.bind(this),this.ballSpeedX=0,this.ballSpeedY=0,this.G=9.8,this.time=null,this.curKey="",this.int=null,this.cvsCtx=this.elMaze.getContext("2d"),this.mazeGrids=[],this.entrance={x:1,y:0},this.exit={x:this.w-2,y:this.h-1},this.initMaze()}initMaze(){var e=this.mazeGrids,t=this.w,i=this.h,s=this.step,a=this.elMaze,l=this.elBall,r=this.ballDia,h=this.entrance,n=this.exit;a.width=t*s,a.height=i*s,window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),window.removeEventListener("devicemotion",this.motionHandler);for(var d=0;d<i;d++){e[d]=[];for(var o=0;o<t;o++)e[d][o]={x:o,y:d,isWall:0===o||0===d||o===t-1||d===i-1,isEntrance:o===h.x&&d===h.y,isExit:o===n.x&&d===n.y,isPath:!1,preGrid:null}}this.drawWall("#004d40","white"),a.style.background="#4D4040",this.drawPath(h,{x:1,y:-1},"#e0f2f1"),this.drawBall(l,r)}fillGrid(e,t,i){var s=this.cvsCtx;s.fillStyle=i,s.fillRect(e*this.step,t*this.step,this.step,this.step)}getFrontGrid(e,t,i,s){var a=2*i-e,l=2*s-t;return!!this.mazeGrids[l]&&!!this.mazeGrids[l][a]?this.mazeGrids[l][a]:null}getFrontLeftGrid(e,t,i,s){var a=2*i-e,l=2*s-t;return i-e==0&&(s-t>0?a+=1:a-=1),s-t==0&&(i-e>0?l-=1:l+=1),!!this.mazeGrids[l]&&!!this.mazeGrids[l][a]?this.mazeGrids[l][a]:null}getFrontRightGrid(e,t,i,s){var a=2*i-e,l=2*s-t;return i-e==0&&(s-t>0?a-=1:a+=1),s-t==0&&(i-e>0?l+=1:l-=1),!!this.mazeGrids[l]&&!!this.mazeGrids[l][a]?this.mazeGrids[l][a]:null}getValidDirections(e,t){var i=this.mazeGrids,s=[],a={x:e,y:t-1},l={x:e,y:t+1},r={x:e-1,y:t},h={x:e+1,y:t};return s.push(a,l,r,h),s=(s=s.filter((s=>{var a,l,r,h,n,d,o=s.x,p=s.y;return!!(l=i[p][o].isExit)||(a=!!i[p]&&!!i[p][o],n=!!this.getFrontGrid(e,t,o,p),!(!a||!n)&&(r=i[p][o].isWall,h=i[p][o].isPath,d=this.getFrontGrid(e,t,o,p).isPath,l||!r&&!h&&!d))}))).map((e=>i[e.y][e.x]))}getDirection(e,t,i){var s,a,l=["front","left","right"],r=e.x,h=e.y,n=t.x,d=t.y,o=i.x,p=i.y;return d===h&&(n>r?(o===n&&p<d&&(s=!0),o===n&&p>d&&(a=!0)):(o===n&&p>d&&(s=!0),o===n&&p<d&&(a=!0))),n===r&&(d>h?(p===d&&o>n&&(s=!0),p===d&&o<n&&(a=!0)):(p===d&&o<n&&(s=!0),p===d&&o>n&&(a=!0))),o-n==n-r||p-d==d-h?l[0]:s?l[1]:a?l[2]:void 0}getRandomDirection(e){var t=[];e.sort((()=>.5-Math.random()));var i=Math.random();for(let s=0;s<=this.gameLevel&&e[s]&&!(s>0&&i>.3);s++)t.push(e[s]);return t}forkPath(e,t,i){var s,a,l={front:null,left:null,right:null},r=[],h=[];i.forEach((i=>{var s=this.getDirection(e,t,i);l[s]=i}));var n=this.getFrontGrid(e.x,e.y,t.x,t.y);if(n.isWall)return i;if(this.getFrontGrid(t.x,t.y,n.x,n.y).isPath)return i;h.push(l.front),r.push(l.front);var d=this.getFrontLeftGrid(e.x,e.y,t.x,t.y);!d.isWall&&l.left?this.getFrontLeftGrid(t.x,t.y,d.x,d.y).isPath?(h.push(l.left),s=!0):(r.push(l.left),s=!1):s=!1;var o=this.getFrontRightGrid(e.x,e.y,t.x,t.y);!o.isWall&&l.right?this.getFrontRightGrid(t.x,t.y,o.x,o.y).isPath?(h.push(l.right),a=!0):(r.push(l.right),a=!1):a=!1;return!s&&!a?this.getRandomDirection(r):h}drawWall(e,t){this.mazeGrids.forEach((i=>{i.forEach((i=>{i.isWall&&this.fillGrid(i.x,i.y,e),i.isEntrance&&this.fillGrid(i.x,i.y,t),i.isExit&&this.fillGrid(i.x,i.y,t)}))}))}drawPath(e,t,i,s){var a=e.x,l=e.y,r=t.x,h=t.y,n=(s=s||this).mazeGrids;if(n[l][a].preGrid={x:r,y:h},n[l][a].isExit)return s.fillGrid(a,l,i),void(n[l][a].isPath=!0);var d=s.getFrontGrid(r,h,a,l),o=d.x,p=d.y;if(!n[l][a].isPath&&!n[p][o].isPath){s.fillGrid(a,l,i),n[l][a].isPath=!0,s.fillGrid(o,p,i),n[p][o].isPath=!0,n[p][o].preGrid={x:a,y:l};var c=s.getValidDirections(o,p);if(0!==c.length){c=s.forkPath(e,d,c);for(let e=0;e<c.length;e++)setTimeout(s.drawPath,0,c[e],n[p][o],i,s)}}}drawCorrectPath(e,t){if(this.useHint=this.useHint||!0,this.fillGrid(e,t,"#ffe0b2"),e!==this.entrance.x||t!==this.entrance.y){var i=this.mazeGrids[t][e].preGrid.x,s=this.mazeGrids[t][e].preGrid.y;this.drawCorrectPath(i,s)}}drawBall(e,t){this.ballX=this.entrance.x*this.step,this.ballY=this.entrance.y*this.step,e.style.width=t+"px",e.style.height=t+"px",e.style.left=this.ballX+"px",e.style.top=this.ballY+"px"}moveBall(e,t,i){var s=this.elBall,a=this.ballX,l=this.ballY;if(i){var r=this.G/1e3*(e/10),h=this.G/1e3*(t/10),n=Date.now();if(this.time){var d=n-this.time;!e||d>50?this.ballSpeedX=0:this.ballSpeedX+=d*r,!t||d>50?this.ballSpeedY=0:this.ballSpeedY+=d*h}else this.time=n;this.time=n}else this.ballSpeedX=e,this.ballSpeedY=t;a+=this.ballSpeedX,l+=this.ballSpeedY;var o=this.getBallValidPosition(a,l);this.ballX=o.x,this.ballY=o.y,this.ballX>=this.exit.x*this.step&&this.ballY>=this.exit.y*this.step&&this.arriveExit(),s.style.left=this.ballX+"px",s.style.top=this.ballY+"px"}getBallValidPosition(e,t){e<=0&&(e=0,this.ballSpeedX=0),t<=0&&(t=0),e>=this.w*this.step-this.ballDia&&(e=this.w*this.step-this.ballDia,this.ballSpeedX=0),t>=this.h*this.step-this.ballDia&&(t=this.h*this.step-this.ballDia);var i={x:~~(e/this.step),y:~~(t/this.step)},s={x:~~(e/this.step),y:~~((t+this.ballDia)/this.step)},a={x:~~((e+this.ballDia)/this.step),y:~~(t/this.step)},l={x:~~((e+this.ballDia)/this.step),y:~~((t+this.ballDia)/this.step)},r=this;function h(e){var t=e.x,i=e.y;return r.mazeGrids[i]&&r.mazeGrids[i][t]&&r.mazeGrids[i][t].isPath}return!h(i)&&h(s)&&h(a)&&h(l)&&(e-i.x*this.step>t-i.y*this.step?(e=(i.x+1)*this.step,this.ballSpeedX=0):(t=(i.y+1)*this.step,this.ballSpeedY=0)),!h(s)&&h(i)&&h(l)&&h(a)&&((s.x+1)*this.step-e<t+this.ballDia-s.y*this.step?(e=(s.x+1)*this.step,this.ballSpeedX=0):(t=s.y*this.step-this.ballDia,this.ballSpeedY=0)),!h(l)&&h(a)&&h(s)&&h(i)&&(t+this.ballDia-l.y*this.step>e+this.ballDia-l.x*this.step?(e=l.x*this.step-this.ballDia,this.ballSpeedX=0):(t=l.y*this.step-this.ballDia,this.ballSpeedY=0)),!h(a)&&h(l)&&h(i)&&h(s)&&((a.y+1)*this.step-t>e+this.ballDia-a.x*this.step?(e=a.x*this.step-this.ballDia,this.ballSpeedX=0):(t=(a.y+1)*this.step,this.ballSpeedY=0)),h(i)||h(s)||(e=(i.x+1)*this.step,this.ballSpeedX=0),h(s)||h(l)||(t=s.y*this.step-this.ballDia,this.ballSpeedY=0),h(a)||h(l)||(e=a.x*this.step-this.ballDia,this.ballSpeedX=0),h(i)||h(a)||(t=(i.y+1)*this.step,this.ballSpeedY=0),{x:e,y:t}}startMove(){window.addEventListener("keydown",this.keyDownHandler),window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("devicemotion",this.motionHandler)}arriveExit(){if(window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),window.removeEventListener("devicemotion",this.motionHandler),this.curKey="",window.clearInterval(this.int),101!==this.w||this.useHint)M.toast({html:'<span class="orange-text text-accent-4">\n                        ✨✨恭喜抵达出口🎉🎉请重新开始游戏\n                       </span>',displayLength:3e3});else{var e=document.querySelector(".modal-trigger"),t=document.querySelector(".modal-close");$(".fireworks").fireworks({sound:!1,opacity:1,width:"80%",height:"100%"}),e.click(),t.addEventListener("click",(()=>{$(".fireworks").html("")}))}}motionHandler(e){var t=e.accelerationIncludingGravity,i=-t.x,s=t.y;this.moveBall(i,s,!0)}keyDownHandler(e){e.preventDefault();switch(e.key){case"w":case"ArrowUp":if("up"===this.curKey)break;window.clearInterval(this.int),this.curKey="up",this.int=window.setInterval(this.moveBall.bind(this),30,0,-5,!1);break;case"a":case"ArrowLeft":if("left"===this.curKey)break;window.clearInterval(this.int),this.curKey="left",this.int=window.setInterval(this.moveBall.bind(this),30,-5,0,!1);break;case"s":case"ArrowDown":if("down"===this.curKey)break;window.clearInterval(this.int),this.curKey="down",this.int=window.setInterval(this.moveBall.bind(this),30,0,5,!1);break;case"d":case"ArrowRight":if("right"===this.curKey)break;window.clearInterval(this.int),this.curKey="right",this.int=window.setInterval(this.moveBall.bind(this),30,5,0,!1)}}keyUpHandler(e){e.preventDefault(),this.curKey="",window.clearInterval(this.int)}}function reGenMaze(){maze=genMaze({width:+elMazeSize.value,height:+elMazeSize.value,gameLevel:+elGameLevel.value})}function startGame(){maze.startMove(),elStartGame.classList.add("disabled"),elStartGame.classList.remove("pulse"),"undefined"==typeof DeviceMotionEvent?M.toast({html:'<span class="red-text">\n                     该浏览器不支持重力感应器！<br>\n                     <span class="red-text text-lighten-3">\n                       请使用方向键移动小球\n                     </span>\n                   </span>\n                   ',displayLength:2e3}):M.toast({html:'<span class="teal-text text-accent-2">\n                     游戏开始！<br>\n                     请晃动手机，或使用方向键移动小球\n                   </span>',displayLength:2e3}),setTimeout((()=>{elGameHint.classList.remove("scale-out"),elGameHint.classList.add("scale-in")}),5e3)}function genMaze(e){var t=Object.assign({elMaze:elMaze,elBall:elBall},e);return elStartGame.classList.remove("disabled"),elStartGame.classList.add("pulse"),elGameHint.classList.remove("scale-in"),elGameHint.classList.add("scale-out"),new Maze(t)}function drawHintPath(){elGameHint.classList.remove("scale-in"),elGameHint.classList.add("scale-out"),maze.drawCorrectPath(maze.exit.x,maze.exit.y)}var elMaze=document.querySelector("#maze-map"),elBall=document.querySelector("#maze-ball"),elMazeWrapper=document.querySelector(".maze"),elControl=document.querySelector(".control"),elStartGame=document.querySelector(".start-game"),elGameLevel=document.querySelector(".game-level"),elMazeSize=document.querySelector(".maze-size"),elGameHint=document.querySelector(".game-hint"),maze=genMaze();elMazeSize.addEventListener("change",(function(){maze=genMaze({width:+this.value,height:+this.value,gameLevel:+elGameLevel.value}),elMazeWrapper.style.width=maze.w*maze.step+"px",elMazeWrapper.style.zoom=elControl.clientWidth/(maze.w*maze.step)})),elGameLevel.addEventListener("change",(function(){maze=genMaze({width:+elMazeSize.value,height:+elMazeSize.value,gameLevel:+this.value})})),elMazeWrapper.style.width=maze.w*maze.step+"px",elMazeWrapper.style.zoom=elControl.clientWidth/(maze.w*maze.step);